<link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.snow.css" type="text/css">


<div id="course-dialog" class="dialog-content-wrapper">
    <mat-toolbar class="mat-accent m-0" *ngIf="!disable_form_title_bar">
        <mat-toolbar-row fxFlex fxLayout="row" fxLayoutAlign="space-between center">
            <span class="title dialog-title" *ngIf="_data.get_title() === null">
                <ng-container *ngIf="_data.get_key_value()">Редактировать запись</ng-container>
                <ng-container *ngIf="!_data.get_key_value()">Создать запись</ng-container>
            </span>
            <span class="title dialog-title" *ngIf="_data.get_title() !== null">Создание записи {{_data.get_title()}}</span>
            <button mat-icon-button (click)="close()" aria-label="Закрыть">
                <mat-icon>close</mat-icon>
            </button>
        </mat-toolbar-row>
    </mat-toolbar>
    <form class="example-container" [formGroup]="form" (ngSubmit)="save()">

        <!--h2 mat-dialog-title>Объект</h2-->
        <div mat-dialog-content class="p-24 m-0">
            <div *ngIf="rows; else loggedOut">
                <ng-container *ngIf="tabs_keys && form_inited">
                    <ng-container *ngIf="tabs_keys.length > 1">
                        <mat-tab-group dynamicHeight>
                            <mat-tab *ngFor="let tab of tabs_keys" label="{{tab}}">
                                <ng-template matTabContent>
                                    <ng-container *ngTemplateOutlet="tab_item; context: {tab:tab, form:form}">
                                    </ng-container>
                                </ng-template>
                            </mat-tab>
                        </mat-tab-group>
                    </ng-container>
                    <ng-container *ngIf="tabs_keys.length == 1">
                        <ng-container *ngTemplateOutlet="tab_item; context: {tab:tabs_keys[0], form:form}">
                        </ng-container>
                    </ng-container>
                </ng-container>
            </div>
        </div>
        <div mat-dialog-actions class="m-0 p-16" fxLayout="row" fxLayoutAlign="space-between center">
            <div>
                <button *ngIf="!disable_save_button" mat-raised-button type="submit" color="accent"  aria-label="Сохранить изменения" matTooltip="Сохранить изменения">
                    Сохранить
                </button>
                <button *ngIf="!disable_cancel_button" mat-raised-button type="button" (click)="close()" aria-label="Не сохранять и закрыть форму" matTooltip="Не сохранять и закрыть форму">
                    Отмена
                </button>

            </div>
            <button *ngIf="_data.key_value != null && !disable_delete" mat-icon-button (click)="delete()" type="button" aria-label="Удалить запись" matTooltip="Удалить запись">
                <mat-icon>delete</mat-icon>
            </button>
        </div>
    </form>

    <ng-template #loggedOut>
        <mat-spinner></mat-spinner>
    </ng-template>

</div>

<ng-template #tab_item let-tab="tab" let-form="form">
    <div [formGroup]="form" fxLayout="row" fxLayoutAlign="start center"  class="flex_wrap">

                            <span
                                *ngFor="let x of tabs[tab]"
                                class="{{get_flex_padding('xl', _data.get_form_type(), records[x])}}"
                                fxFlex.xl="{{get_flex_width('xl', _data.get_form_type(), records[x])}}"
                                fxFlex.lg="{{get_flex_width('lg', _data.get_form_type(), records[x])}}"
                                fxFlex.lt-md="{{get_flex_width('md', _data.get_form_type(), records[x])}}"
                                fxFlex.md="{{get_flex_width('md', _data.get_form_type(), records[x])}}"
                                fxFlex.xs="{{get_flex_width('xs', _data.get_form_type(), records[x])}}"
                                fxFlex.gt-xs="{{get_flex_width('xs', _data.get_form_type(), records[x])}}"
                                [hidden]="records[x].hidden || records[x].type == 'hidden'"
                            >

                                <span [ngSwitch]="records[x].type">

                                    <input *ngSwitchCase="'hidden'" [hidden]="true" readonly matInput [formControlName]="records[x].name" placeholder="{{records[x].title}}">

                                    <mat-form-field appearance="{{get_appearance()}}" *ngSwitchCase="'primary_key'" [hidden]="records[x].hidden">
                                        <mat-label>{{records[x].title}}</mat-label>
                                        <input class="disabled-text" readonly matInput [formControlName]="records[x].name" placeholder="{{records[x].title}}">
                                    </mat-form-field>

                                    <mat-form-field appearance="{{get_appearance()}}" *ngSwitchCase="'date'" [hidden]="records[x].hidden">
                                        <mat-label>{{records[x].title}}</mat-label>
                                        <input matInput [formControlName]="records[x].name" [required]="records[x].required_boolean" (click)="dp.open()" [matDatepicker]="dp" placeholder="{{records[x].title}}">
                                        <mat-datepicker-toggle matSuffix [for]="dp"></mat-datepicker-toggle>
                                        <mat-datepicker #dp
                                                        panelClass="example-month-picker">
                                        </mat-datepicker>
                                    </mat-form-field>

                                    <mat-form-field appearance="{{get_appearance()}}" *ngSwitchCase="'dttime'" [hidden]="records[x].hidden">
                                        <mat-label>{{records[x].title}}</mat-label>
                                        <input matInput [formControlName]="records[x].name" [required]="records[x].required_boolean" [ngxTimepicker]="picker" [format]="24" placeholder="{{records[x].title}}">
                                        <mat-icon matSuffix>access_time</mat-icon>
                                        <ngx-material-timepicker #picker></ngx-material-timepicker>
                                    </mat-form-field>

                                    <mat-form-field appearance="{{get_appearance()}}" *ngSwitchCase="'dtdatetime'" [hidden]="records[x].hidden">
                                        <mat-label>{{records[x].title}}</mat-label>
                                        <input matInput [formControlName]="records[x].name" [required]="records[x].required_boolean" (click)="dp.open()" [matDatepicker]="dp" placeholder="{{records[x].title}}">
                                        <mat-datepicker-toggle matSuffix [for]="dp"></mat-datepicker-toggle>
                                        <mat-datepicker #dp
                                                        panelClass="example-month-picker">
                                        </mat-datepicker>
                                    </mat-form-field>

                                    <mat-form-field appearance="{{get_appearance()}}" *ngSwitchCase="'docuploads'">
                                        <mat-label>{{records[x].title}}</mat-label>
                                        <input [formControlName]="records[x].name" matInput [hidden]="true">
                                        <ng-container *ngIf="records[x].value.length > 0">
                                            <span *ngFor="let doc of records[x].value">
                                                <a href="{{doc.normal_url}}" target="_blank">{{doc.normal}}</a> |
                                            </span>
                                        </ng-container>
                                    </mat-form-field>

                                    <mat-form-field appearance="{{get_appearance()}}" *ngSwitchCase="'dtdate'" [hidden]="records[x].hidden">
                                        <mat-label>{{records[x].title}}</mat-label>
                                        <input matInput [formControlName]="records[x].name" [required]="records[x].required_boolean" (click)="dp.open()" [matDatepicker]="dp" placeholder="{{records[x].title}}">
                                        <mat-datepicker-toggle matSuffix [for]="dp"></mat-datepicker-toggle>
                                        <mat-datepicker #dp
                                                        panelClass="example-month-picker">
                                        </mat-datepicker>
                                    </mat-form-field>

                                    <uploader-component [hidden]="records[x].hidden" *ngSwitchCase="'uploads'" [galleryImages]="galleryImages" [entity]="_data" [image_field]="records[x].name"></uploader-component>

                                    <uploader-component [hidden]="records[x].hidden" *ngSwitchCase="'photo'" [galleryImages]="galleryImages" [entity]="_data" [image_field]="records[x].name" [max_uploads]="1"></uploader-component>

                                    <span *ngSwitchCase="'select_box_structure'" [hidden]="records[x].hidden">
                                        <ng-select [formControlName]="records[x].name"
                                                   [required]="records[x].required_boolean"
                                                   appendTo="body"
                                                   bindValue="id"
                                                   bindLabel="name"
                                                   [items]="options_storage[records[x].name]"
                                                   [clearOnBackspace]="false"
                                                   [searchable]="true"
                                                   [multiple]="false"
                                                   [hideSelected]="false"
                                                   (change)="apply_topic_activity()"
                                                   [closeOnSelect]="true"
                                                   placeholder="{{records[x].title}}">
                                            <ng-template ng-label-tmp let-item="item" let-index="index">
                                                <span [innerHTML]="item.breadcrumbs">
                                                </span>
                                            </ng-template>

                                            <ng-template ng-option-tmp let-item="item" let-index="index">

                                                <span [innerHTML]="item.name" class="level{{item.level}}">
                                                </span>
                                            </ng-template>
                                        </ng-select>
                                        <mat-error *ngIf="form.controls[records[x].name].status == 'INVALID' && form_submitted">{{records[x].title}} обязательное поле!</mat-error>
                                    </span>


                                    <span *ngSwitchCase="'select_by_query'"  [hidden]="records[x].hidden">
                                        <div fxLayout="row">
                                            <div fxFlex="90" class="min-select">
                                                <ng-select [formControlName]="records[x].name"
                                                           [required]="records[x].required_boolean"
                                                           appendTo="body"
                                                           class="auto-grow"
                                                           bindValue="id"
                                                           bindLabel="value"
                                                           [items]="options_storage_buffer[records[x].name]"
                                                           [virtualScroll]="true"
                                                           [loading]="loading"
                                                           (scroll)="onScroll($event, records[x].name)"
                                                           (scrollToEnd)="onScrollToEnd(records[x].name)"
                                                           [clearOnBackspace]="false"
                                                           [searchable]="true"
                                                           [typeahead]="input$"
                                                           (search)="onSearch(records[x].name)"
                                                           [multiple]="false"
                                                           (focus)="init_select_by_query_options(records[x].name)"
                                                           [hideSelected]="false"
                                                           [closeOnSelect]="true"
                                                           placeholder="{{records[x].title}}">
                                                    <ng-template ng-label-tmp let-item="item" let-index="index">
                                                        <span [innerHTML]="item.value">
                                                        </span>
                                                    </ng-template>

                                                    <ng-template ng-option-tmp let-item="item" let-index="index">
                                                        <span [innerHTML]="item.value">
                                                        </span>
                                                    </ng-template>
                                                </ng-select>
                                                <mat-error *ngIf="form.controls[records[x].name].status == 'INVALID' && form_submitted">{{records[x].title}} обязательное поле!</mat-error>
                                            </div>
                                            <div fxFlex="10" *ngIf="modelService.get_access(records[x].primary_key_table, 'access')">
                                                <a mat-mini-fab (click)="inline_create(records[x])" color="fuse-white" matTooltip="Добавить запись">
                                                    <mat-icon>add</mat-icon>
                                                </a>
                                            </div>
                                        </div>
                                    </span>

                                    <span *ngSwitchCase="'select_box'" [hidden]="records[x].hidden">
                                        <ng-select [formControlName]="records[x].name"
                                                   [required]="records[x].required_boolean"
                                                   appendTo="body"
                                                   bindValue="id"
                                                   bindLabel="value"
                                                   [items]="options_storage[records[x].name]"
                                                   [clearOnBackspace]="false"
                                                   [searchable]="false"
                                                   [multiple]="false"
                                                   [hideSelected]="false"
                                                   [closeOnSelect]="true"
                                                   placeholder="{{records[x].title}}">
                                            <ng-template ng-label-tmp let-item="item">
                                                <span [innerHTML]="item.value">
                                                </span>
                                            </ng-template>

                                            <ng-template ng-option-tmp let-item="item" let-index="index">
                                                <span [innerHTML]="item.value">
                                                </span>
                                            </ng-template>
                                        </ng-select>
                                        <mat-error *ngIf="form.controls[records[x].name].status == 'INVALID' && form_submitted">{{records[x].title}} обязательное поле!</mat-error>
                                    </span>

                                    <mat-checkbox
                                        [hidden]="records[x].hidden"
                                        *ngSwitchCase="'checkbox'"
                                        class="form-checkbox"
                                        [required]="records[x].required_boolean"
                                        matInput
                                        [formControlName]="records[x].name"
                                    >{{records[x].title}}</mat-checkbox>

                                    <mat-form-field [hidden]="records[x].hidden" *ngSwitchCase="'textarea_editor'">
                                        <quill-editor [(ngModel)]="text_area_editor_storage[records[x].name]" [modules]="quillConfig" [ngModelOptions]="{standalone: true}"></quill-editor>
                                        <input [formControlName]="records[x].name" matInput [hidden]="true">
                                        <mat-error>{{records[x].title}} обязательное поле!</mat-error>
                                    </mat-form-field>
                                    <span [hidden]="records[x].hidden" *ngSwitchCase="'geodata'">

                                        <div fxLayout="column" fxLayoutAlign="start" fxFlex="1 0 auto">
                                            <div fxLayout="row" fxLayoutAlign="start center" fxFlex="1 0 auto">
                                                <span fxFlex="100">Координаты</span>
                                            </div>

                                            <div fxLayout="row" fxLayoutAlign="start center" fxFlex="1 0 auto">
                                                <mat-form-field fxFlex="50" class="pr-4">
                                                    <input matInput [(ngModel)]="lat" placeholder="lat" [ngModelOptions]="{standalone: true}" [required]="records[x].required_boolean">
                                                </mat-form-field>
                                                <mat-form-field fxFlex="50" class="pl-4">
                                                    <input matInput [(ngModel)]="lng" placeholder="lng" [ngModelOptions]="{standalone: true}" [required]="records[x].required_boolean">
                                                </mat-form-field>
                                            </div>
                                            <div fxLayout="row" fxLayoutAlign="start center" fxFlex="1 0 auto">
                                                <mat-form-field fxFlex="100">
                                                    <!--ya-map [latitude]="55.76" [longitude]="37.64" (mapClick)="mapClick($event)">
                            <ya-marker
                                       [latitude]="lat"
                                       [longitude]="lng"
                                       [draggable]="true"
                                       >
                            </ya-marker>
                        </ya-map-->
                                                    <agm-map [latitude]="lat_center" [longitude]="lng_center" (mapClick)="mapClick($event)">
                                                        <ng-container *ngIf="lat != '' && lng != ''">
                                                            <agm-marker [latitude]="lat" [longitude]="lng"></agm-marker>
                                                        </ng-container>
                                                    </agm-map>

                                                    <input [formControlName]="records[x].name" matInput [hidden]="true">
                                                    <mat-error>{{records[x].title}} обязательное поле!</mat-error>
                                                </mat-form-field>

                                            </div>

                                        </div>



                                    </span>

                                    <mat-form-field appearance="{{get_appearance()}}" [hidden]="records[x].hidden" *ngSwitchCase="'textarea'">
                                        <mat-label>{{records[x].title}}</mat-label>
                                        <textarea matInput matTextareaAutosize [formControlName]="records[x].name" [required]="records[x].required_boolean" placeholder="{{records[x].title}}"></textarea>
                                        <mat-error>{{records[x].title}} обязательное поле!</mat-error>
                                    </mat-form-field>

                                    <mat-form-field [hidden]="records[x].hidden" *ngSwitchCase="'password'">
                                        <input matInput type="password" [formControlName]="records[x].name" [required]="records[x].required_boolean" placeholder="{{records[x].title}}">
                                        <mat-error>{{records[x].title}} обязательное поле!</mat-error>
                                    </mat-form-field>

                                    <div [hidden]="records[x].hidden" *ngSwitchCase="'injector'">
                                        <sb-booking *ngIf="records[x].name === 'booking'" [keyValue]="_data.key_value"></sb-booking>
                                        <house-schema-builder *ngIf="records[x].name === 'house_schema_builder'" [keyValue]="_data.key_value"></house-schema-builder>
                                        <user-profile *ngIf="records[x].name === 'user_profile'" [user_id]="this.modelService.get_user_id()"></user-profile>
                                    </div>

                                    <mat-form-field appearance="{{get_appearance()}}" [hidden]="records[x].hidden" *ngSwitchDefault>
                                        <mat-label>{{records[x].title}}</mat-label>
                                        <input matInput [formControlName]="records[x].name" [required]="records[x].required_boolean" placeholder="{{records[x].title}}">
                                        <mat-error>{{records[x].title}} обязательное поле!</mat-error>
                                    </mat-form-field>
                                </span>
                            </span>
    </div>
</ng-template>
